== Welcome to Trax

Trax is a web-application and persistance framework that includes everything
needed to create database-backed web-applications according to the
Model-View-Control pattern of separation. This pattern splits the view (also
called the presentation) into "dumb" templates that are primarily responsible
for inserting pre-build data in between HTML tags. The model contains the
"smart" domain objects (such as Account, Product, Person, Post) that holds all
the business logic and knows how to persist themselves to a database. The
controller handles the incoming requests (such as Save New Account, Update
Product, Show Post) by manipulating the model and directing data to the view.

In Trax, the model is handled by what's called a object-relational mapping
layer entitled Active Record. This layer allows you to present the data from
database rows as objects and embellish these data objects with business logic
methods. 

The controller and view is handled by the Action Controller

== Requirements

* Database (MySQL, PostgreSQL, etc) (uses Pear::DB)
* PHP 5.x
* PEAR::DB, PEAR::Mail, PEAR::Mail_mime
* Apache 1.3.x or 2.x 
* FreeBSD, Unix, Linux, MacOSX, Windows

== Getting Started

1. edit config/environment.php
    set if its development/test/production environment
2. edit config/database.ini
    set database parameters
3. edit public_html/.htaccess
    set the path to your pear installation (/usr/local/lib/php - on my box) 
    set the path to the config dir for trax (/home/<username>/trax/config)
    example: .htaccess - php_value include_path .:/usr/local/lib/php:/home/<username>/trax/config   
4. set the owner of your log files to the webserver user (www, apache, nobody, ...) or 
   chmod them to 777 so the web server can write to the logs.
   example: 
    cd /path/to/log/
    chown www *
    or
    chmod 777 *
4. create your database and use script/generator.php to 
   generate model, controller, and view files
   ./generate.php model user (singular names must be used)
   ./generate.php controller [controller name] [view1 view2 view3 ...]
5. main site layouts should be in app/views/layouts
   default: public.phtml
   content from view files are displayed in the layout phtml file
   by using the variable <?= $content_for_layout ?>

== Naming Schema

* controller names should be Camelized (MyClass). 
* models should be use singular names such as customer not customers.
* table names should always be plural.
* foriegn keys should always be singular with _id on the end.


== ActiveRecord

*Table Relationships

In each model class you can define table relationships.
Allowed relationships in model classes are: 
* belongs_to: means that there is a foreign key from another table in in this table.
    public $belongs_to = array("foreign_table_name" => null);
    - foreign table name is always singular.
* has_one: means that there is a foreign key in another table to this table
    public $belongs_to = array("foreign_table_name" => null);
     - foreign table name is always singular.
* has_many: means that there is a foreign key in another table to this table
    public $belongs_to = array("foreign_table_name" => null);
     - foreign table name is always plural.
* has_and_belongs_to_many: means there is a join with another table into a third joining table
    public $belongs_to = array("foreign_table_name" => null);
     - foreign table name is always plural.
     - joining table must be named table1_table2 (plural names for both)

In place of the null you can specify an array of parameters such as "foreign_key".
    public $belongs_to = array("table_name" => array("foreign_key" => "otherkey_id")); 

If the models name isn't the singular name of the corresponding table it goes with, you can in
the model specify the table name.  (public $table_name = "different_name";) 

* Functions
  
    * find_all([conditions], [orderings], [limit], [joins])
        $array_of_objects = $model->find_all(); // everything
        $array_of_objects = $model->find_all("id > 10"); // everyone with id > 10

    * find(id, [conditions])
        $object = $model->find($id); // one object where id=$id

    * find_first([conditions])
        $object = $model->find_first("last_name = 'Smith'"); // one object , first row in result set where last_name='Smith'

    * find_all_by_[param1]_or|and_[param2]...(param1,param2,etc...,[ordering])
        $array_of_objects = $model->find_all_by_lastname_and_firstname_or_last_name("Smith","John","Jones","last_name DESC"); // everything
        - lastname and firstname are fields in the table. 
        - the function params are the matching order for the fields in the function name
        - optional last param is the ordering.

    for aggregrations you can do the following: ("count","sum","avg","max","min")
        $model->count_all("field",[conditions]); (sum_all, avg_all, etc)
    
for auto updating datetime fields there are 2 arrays defined. Any table with fields with these names
will be auto updated when inserting or updating. If you want to turn off auto updating you can set the
class var $auto_timestamps = false;    
    protected $auto_update_timestamps = array("updated_at","updated_on");
    protected $auto_create_timestamps = array("created_at","created_on");  


== Logging

Log files for php errors or if you put in your code error_log("whatever") will be writen to
the trax/log folder in development|test|production.log file depending on the TRAX_MODE

If your application has errors or if you want to print something to the log, then
any where in your code if you use the built in php function "error_log('some message')"
it will write the message to the trax/log/development.log or whatever mode your in log file.
    
== Description of contents

trax/app
  Holds all the code that's specific to this particular application.

trax/app/controllers
  Holds controllers that should be named like weblog_controller.php for
  automated URL mapping. All controllers should descend from
  ActionController.

trax/app/libs
  Application specific libraries. Basically, any kind of custom code that doesn't
  belong controllers, models, or helpers. This directory is in the includes path.

trax/app/models
  Holds models that should be named like post.rb.
  Most models will descent from ActiveRecord.
  
trax/app/views
  Holds the template files for the view that should be named like
  weblog/index.phtml for the WeblogController->index action.

trax/app/helpers
  Holds view helpers that should be named like weblog_helper.php.
 
trax/config
  Configuration files for the Trax environment, the routing map, the database, and other dependencies.

trax/lib
  Trax libraries. This directory is in the includes path.

trax/script
  Helper scripts for automation and generation.
    
public / public_html
  The directory available for the web server. Contains sub-directories for images, stylesheets,
  and javascripts. Also contains the .htaccess, dispatcher, and default HTML files.

== Notes

Any thing set as a class variable in the controller with become a regular variable in the view file.
example: ($this->users becomes $users in the view file as with any class ($this->xxx) variable)
    url: /browse/show_all

    controller (browse_controller.php):
        function show_all() {    
            $user = new User();
            $this->users = user->find_all();
        }
        
    view file (show_all.phtml):
        <? if(count($users) > 0): ?>
            <? foreach($users as $user): ?>
                <?=$user->first_name?> <?=$user->last_name?><br>
            <? endforeach; ?>
        <? endif; ?>         

    view results:
        john smith
        joe smith
        larry king
        ...

        
== Example App

URL:
http://traxtest.mytechsupport.com

Trax Code:

###   config/database.ini ###
[development]
  phptype = mysql
  database =  mydb_development
  host = localhost
  username = user
  password = ******
  persistent = 1

###   MySQL Table: ###
CREATE TABLE `files` (
  `id` int(11) NOT NULL auto_increment,
  `owner` varchar(50) NOT NULL default '',
  `name` varchar(50) NOT NULL default '',
  `contents` text NOT NULL,
  `created_at` datetime NOT NULL default '0000-00-00 00:00:00',
  PRIMARY KEY  (`id`)
);  

###   config/routes.php ###
// this tells trax to route the root domain to the file_list controller
// same as just going to http://traxtest.mytechsupport.com/file_list
$router->connect( "", array(":controller" => "file_list") );

###   app/controllers/file_list_controller.php  ####
class FileListController extends ApplicationController {
    function index() {
        $file = new File();
        $this->files = $file->find_all();
    }

    function edit() {
        $file = new File();
        $this->file = $file->find($_REQUEST['id']);
        if($_POST) {
            if(!$this->file->save($_REQUEST['file'])) {
                $_SESSION['flash']['error'] = @implode("<br>",$this->file->errors);
            } else {
                $_SESSION['flash']['notice'] = "File saved successfully.";
                $this->redirect_to = "/file_list";
            }
        }
    }

    function add() {
        $this->file = new File($_REQUEST['file']);
        if($_POST) {
            if(!$this->file->save()) {
                $_SESSION['flash']['error'] = @implode("<br>",$this->file->errors);
            } else {
                $_SESSION['flash']['notice'] = "File added successfully.";
                $this->redirect_to = "/file_list";
            }
        }
    }

    function delete() {
        $file = new File();
        $this->file = $file->find($_REQUEST['id']);
        if(is_object($this->file)) {
            if(!$this->file->delete()) {
                $_SESSION['flash']['error'] = "Error deleting file.";
                $this->render_action = "edit";
            } else {
                $_SESSION['flash']['notice'] = "File deleted successfully.";
                $this->redirect_to = "/file_list";
            }
        } else {
            $_SESSION['flash']['error'] = "Error can't find file to delete.";
            $this->render_action = "edit";
        }
    }
}

Model
###   app/models/file.php  ####
class File extends ActiveRecord {

    function validate_name() {
        return array(!empty($this->name), 'Please don\'t leave name blank.');
    }

    function validate_owner() {
        return array(!empty($this->owner), 'Please don\'t leave owner blank.');
    }

    function validate_contents() {
        if(strlen($this->contents) < 15)
            return array(false, 'Contents needs to be at least 15 characters long.');
        else
            return array(true, null);
    }

}

Views
###   app/views/file_list/add.phtml  ####
<h1>FileList->add</h1>
<form method="post" action="/file_list/add">
<? $this->render_partial("form") ?>
</form>
<br>
<a href="/file_list">back</a>

###   app/views/file_list/edit.phtml  ####
<h1>FileList->edit</h1>
<form method="post" action="/file_list/edit/<?=$file->id?>">
<? $this->render_partial("form") ?>
</form>
<br>
<a href="/file_list">back</a> &nbsp; <a href="/file_list/delete/<?=$file->id?>">delete</a>

Partial Views
###  app/views/file_list/_form.phtml  ####
<table>
<tr>
    <td>Id: </td>
    <td><?=$file->id?></td>
</tr>
<tr>
    <td>Name: </td>
    <td><input type="text" name="file[name]" value="<?=$file->name?>"/></td>
</tr>
<tr>
    <td>Owner: </td>
    <td><input type="text" name="file[owner]" value="<?=$file->owner?>"/></td>
<tr>
    <td valign="top">Contents: </td>
    <td><textarea name="file[contents]" rows="10" cols="80"><?=$file->contents?></textarea></td>
</tr>
<tr>
    <td>Created: </td>
    <td><?=$file->created_at?></td>
</tr>
<tr>
    <td colspan="2"><input type="submit" value=" Save "/></td>
</tr>
</table>

Site layout file:
### app/layouts/public.phtml
<html>
<head>
<title>PHP on Trax</title>
</head>
<body>

<? if($_SESSION['flash']['notice']): ?>
    <font color="green"><?=$_SESSION['flash']['notice']?></font><br><br>
<? elseif($_SESSION['flash']['error']): ?>
    <font color="red"><?=$_SESSION['flash']['error']?></font><br><br>
<? endif; ?>

<?=$content_for_layout?>

</body>
</html>

      